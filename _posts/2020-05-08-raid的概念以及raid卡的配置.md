---
layout: post
title: RAID 的概念以及 RAID 卡的配置
categories: [raid]
description:
keywords: 
---

# RAID 的概念以及 RAID 卡的配置

## RAID 基础概念

### 基本原理

RAID （ Redundant Array of Independent Disks ）即独立磁盘冗余阵列，通常简称为磁盘阵列。简单地说， RAID 是由多个独立的高性能磁盘驱动器组成的磁盘子系统，从而提供比单个磁盘更高的存储性能和数据冗余的技术。 RAID 是一类多磁盘管理技术，其向主机环境提供了成本适中、数据可靠性高的高性能存储。 SNIA 对 RAID 的定义是 ：一种磁盘阵列，部分物理存储空间用来记录保存在剩余空间上的用户数据的冗余信息。当其中某一个磁盘或访问路径发生故障时，冗余信息可用来重建用户数据。磁盘条带化虽然与 RAID 定义不符，通常还是称为 RAID （即 RAID0 ）。

这里要提一下 JBOD （ Just a Bunch of Disks ）。最初 JBOD 用来表示一个没有控制软件提供协调控制的磁盘集合，这是 RAID 区别与 JBOD 的主要因素。目前 JBOD 常指磁盘柜，而不论其是否提供 RAID 功能。

### 软/硬 RAID

软件 RAID：操作系统下实现 RAID，软 RAID 不能保护系统盘。亦即系统分区不能参与实现 RAID。有些操作系统，RAID 的配置信息存在系统信息中，而不是存在硬盘上；当系统崩溃，需重新安装时，RAID 的信息也会丢失。

硬件 RAID：是采用集成的阵列卡或专用的阵列卡来控制硬盘驱动器，这样可以极大节省服务器系统 CPU 和操作系统的资源。从而使服务器的性能获得很大的提高。

### RAID 的分类

|RAID等级|RAID0|RAID1|RAID5|RAID6|RAID10|
|----|------|-----|-----|-----|------|
|别名|条带|镜像|分布奇偶校验条带|双重奇偶校验条带|镜像加条带|
|容错性|无|有|有|有|有|
|冗余类型|无|有|有|有|有|
|热备盘|无|有|有|有|有|
|读性能|高|低|高|高|高|
|随机写性能|高|低|一般|低|一般|
|连续写性能|高|低|低|低|一般|
|需要磁盘数|n≥1|2n (n≥1)|n≥3|n≥4|2n(n≥2)≥4|
|可用容量|全部|50%|(n-1)/n|(n-2)/n|50%|

### RAID 的优势

#### 大容量

这是 RAID 的一个显然优势，它扩大了磁盘的容量，由多个磁盘组成的 RAID 系统具有海量的存储空间。现在单个磁盘的容量就可以到 1TB 以上，这样 RAID 的存储容量就可以达到 PB 级，大多数的存储需求都可以满足。一般来说， RAID 可用容量要小于所有成员磁盘的总容量。不同等级的 RAID 算法需要一定的冗余开销，具体容量开销与采用算法相关。如果已知 RAID 算法和容量，可以计算出 RAID 的可用容量。通常， RAID 容量利用率在 50% ~ 90% 之间。

#### 高性能

RAID 的高性能受益于数据条带化技术。单个磁盘的 I/O 性能受到接口、带宽等计算机技术的限制，性能往往很有 限，容易成为系统性能的瓶颈。通过数据条带化， RAID 将数据 I/O 分散到各个成员磁盘上，从而获得比单个磁盘成倍增长的聚合 I/O 性能。

#### 可靠性

可用性和可靠性是 RAID 的另一个重要特征。从理论上讲，由多个磁盘组成的 RAID 系统在可靠性方面应该比单个磁盘要差。这里有个隐含假定：单个磁盘故障将导致整个 RAID 不可用。 RAID 采用镜像和数据校验等数据冗余技术，打破了这个假定。 镜像是最为原始的冗余技术，把某组磁盘驱动器上的数据完全复制到另一组磁盘驱动器上，保证总有数据副本可用。 比起镜像 50% 的冗余开销 ，数据校验要小很多，它利用校验冗余信息对数据进行校验和纠错。 RAID 冗余技术大幅提升数据可用性和可靠性，保证了若干磁盘出错时，不 会导致数据的丢失，不影响系统的连续运行。

#### 可管理性

实际上， RAID 是一种虚拟化技术，它对多个物理磁盘驱动器虚拟成一个大容量的逻辑驱动器。对于外部主机系统来说， RAID 是一个单一的、快速可靠的大容量磁盘驱动器。这样，用户就可以在这个虚拟驱动器上来组织和存储应用系统数据。 从用户应用角度看，可使存储系统简单易用，管理也很便利。 由于 RAID 内部完成了大量的存储管理工作，管理员只需要管理单个虚拟驱动器，可以节省大量的管理工作。 RAID 可以动态增减磁盘驱动器，可自动进行数据校验和数据重建，这些都可以 大大简化管理工作。

### 三大关键技术

#### 镜像

镜像是一种冗余技术，为磁盘提供保护功能，防止磁盘发生故障而造成数据丢失。对于 RAID 而言，采用镜像技术 典型地 将会同时在阵列中产生两个完全相同的数据副本，分布在两个不同的磁盘驱动器组上。镜像提供了完全的数据冗余能力，当一个数据副本失效不可用时，外部系统仍可正常访问另一副本，不会对应用系统运行和性能产生影响。而且，镜像不需要额外的计算和校验，故障修复非常快，直接复制即可。镜像技术可以从多个副本进行并发读取数据，提供更高的读 I/O 性能，但不能并行写数据，写多个副本会会导致一定的 I/O 性能降低。

镜像技术提供了非常高的数据安全性，其代价也是非常昂贵的，需要至少双倍的存储空间。高成本限制了镜像的广泛应用，主要应用于至关重要的数据保护，这种场合下数据丢失会造成巨大的损失。另外，镜像通过 “ 拆分 ” 能获得特定时间点的上数据快照，从而可以实现一种备份窗口几乎为零的数据备份技术。

#### 数据条带

磁盘存储的性能瓶颈在于磁头寻道定位，它是一种慢速机械运动，无法与高速的 CPU 匹配。再者，单个磁盘驱动器性能存在物理极限， I/O 性能非常有限。 RAID 由多块磁盘组成，数据条带技术将数据以块的方式分布存储在多个磁盘中，从而可以对数据进行并发处理。这样写入和读取数据就可以在多个磁盘上同时进行，并发产生非常高的聚合 I/O ，有效提高了整体 I/O 性能，而且具有良好的线性扩展性。这对大容量数据尤其显著，如果不分块，数据只能按顺序存储在磁盘阵列的磁盘上，需要时再按顺序读取。而通过条带技术，可获得数倍与顺序访问的性能提升。

数据条带技术的分块大小选择非常关键。条带粒度可以是一个字节至几 KB 大小，分块越小，并行处理能力就越强，数据存取速度就越高，但同时就会增加块存取的随机性和块寻址时间。实际应用中，要根据数据特征和需求来选择合适的分块大小，在数据存取随机性和并发处理能力之间进行平衡，以争取尽可能高的整体性能。

数据条带是基于提高 I/O 性能而提出的，也就是说它只关注性能， 而对数据可靠性、可用性没有任何改善。实际上，其中任何一个数据条带损坏都会导致整个数据不可用，采用数据条带技术反而增加了数据发生丢失的概念率。

#### 数据校验

镜像具有高安全性、高读性能，但冗余开销太昂贵。数据条带通过并发性来大幅提高性能，然而对数据安全性、可靠性未作考虑。数据校验是一种冗余技术，它用校验数据来提供数据的安全，可以检测数据错误，并在能力允许的前提下进行数据重构。相对镜像，数据校验大幅缩减了冗余开销，用较小的代价换取了极佳的数据完整性和可靠性。数据条带技术提供高性能，数据校验提供数据安全性， RAID 不同等级往往同时结合使用这两种技术。

采用数据校验时， RAID 要在写入数据同时进行校验计算，并将得到的校验数据存储在 RAID 成员磁盘中。校验数据可以集中保存在某个磁盘或分散存储在多个不同磁盘中，甚至校验数据也可以分块，不同 RAID 等级实现各不相同。当其中一部分数据出错时，就可以对剩余数据和校验数据进行反校验计算重建丢失的数据。校验技术相对于镜像技术的优势在于节省大量开销，但由于每次数据读写都要进行大量的校验运算，对计算机的运算速度要求很高，必须使用硬件 RAID 控制器。在数据重建恢复方面，检验技术比镜像技术复杂得多且慢得多。

海明校验码和 异或校验是两种最为常用的 数据校验算法。海明校验码是由理查德 · 海明提出的，不仅能检测错误，还能给出错误位置并自动纠正。海明校验的基本思想是：将有效信息按照某种规律分成若干组，对每一个组作奇偶测试并安排一个校验位，从而能提供多位检错信息，以定位错误点并纠正。可见海明校验实质上是一种多重奇偶校验。异或校验通过异或逻辑运算产生，将一个有效信息与一个给定的初始值进行异或运算，会得到校验信息。如果有效信息出现错误，通过校验信息与初始值的异或运算能还原正确的有效信息。

## RAID 卡概念

RAID 卡指实现了 RAID 的 HBA 卡。通常是由I/O处理器、硬盘控制器、硬盘连接器和缓存等一系列零组件构成的。

> HBA 卡（Host Bus Adaptor）：用于连接服务器内部 I/O 通道和储存系统 I/O 通道（外部）之间的物理连接接口通常，服务器 PC 主板都支持 IDE 协议，而 IDE 磁盘控制器支持 IDE 协议，应此两者可以直接链接。但是若磁盘只支持 SCSI 协议，那么就不能直接与服务器连接，需要插一块 SCSI 卡（HBA 卡），实现对磁盘的支持，这样，SCSI 卡就成为了总线主机适配卡 HBA。HBA 卡的范围也是比较广范的。

RAID 卡按照磁盘传输协议，可以分为 SATA RAID 卡，SAS RAID 卡，SCSI RAID 卡。但在服务器领域，一般都是 SAS RAID 卡。按照卡上的 SCSI 控制器可以分为单通道、双通道、三通道甚至八通道的 RAID 卡。而通道代表着可以带多少块盘，比例关系，即 **通道数\*单控制器可带动磁盘数**。

> 如果没有集成 SCSI 控制器,而是借用主板上的 SCSI 控制器来管理硬盘，则为零通道 RAID 卡。

除此之外，RAID 一般还会有 cache 和 bbu 的配备，前者是缓存，后者是数据完整性而配置的电池。

### RAID 卡的配置

RAID 卡的配置一般是指对磁盘进行 RAID 管理。主要设置读写策略吗，优化磁盘 I/O。

由于业务需求，暂定使用 24 SAS 盘位的磁盘背板，单线连接到八通道 RAID 卡上。

磁盘 RAID 等级为 RAID5，使用 23 块盘作为数据/校验盘，1 块盘热备盘。

- 读模式为 RRead Ahead Always（R）。
- 写模式为 Always WriteBack（AWB）。
- 读操作缓存 Cached IO（C）。
- 条带大小为 256kb。（后期可根据需求变更）。

## 参考

- [RAID 卡技术简析](https://blog.csdn.net/JuanA1/article/details/7017394)
- [RAID 磁盘阵列配置和调优小结](https://wsgzao.github.io/post/raid/)
- [Linux RAID 卡优化](https://www.cnblogs.com/chenmh/p/5846766.html)
- [RAID 卡原理与设置](https://www.iteye.com/blog/fangrn-569976)
